<?xml version="1.0" encoding="UTF-8"?>

<?import javafx.geometry.Insets?>
<?import javafx.scene.control.Button?>
<?import javafx.scene.control.Label?>
<?import javafx.scene.control.SplitPane?>
<?import javafx.scene.control.Tab?>
<?import javafx.scene.control.TabPane?>
<?import javafx.scene.control.TableColumn?>
<?import javafx.scene.control.TableView?>
<?import javafx.scene.control.TextArea?>
<?import javafx.scene.control.TextField?>
<?import javafx.scene.control.ProgressIndicator?>
<?import javafx.scene.control.TitledPane?>
<?import javafx.scene.control.CheckBox?>
<?import javafx.scene.control.ComboBox?>
<?import javafx.scene.control.Slider?>
<?import javafx.scene.control.Label?>
<?import javafx.scene.web.WebView?>
<?import javafx.scene.layout.HBox?>
<?import javafx.scene.layout.VBox?>
<?import javafx.scene.layout.GridPane?>
<?import javafx.scene.layout.ColumnConstraints?>
<?import javafx.scene.control.ScrollPane?>
<?import javafx.scene.layout.Region?>

<!--
    历史数据查看窗口布局文件
    使用 TableView 显示流量历史记录
-->
<VBox spacing="15.0" xmlns="http://javafx.com/javafx"
      xmlns:fx="http://javafx.com/fxml"
      fx:controller="com.netpulse.netpulsefx.HistoryController"
      stylesheets="@history-view.css"
      prefHeight="500.0" prefWidth="800.0">
    <!-- 设置整体内边距 -->
    <padding>
        <Insets bottom="20.0" left="20.0" right="20.0" top="20.0"/>
    </padding>

    <!-- 标题 -->
    <Label text="流量历史数据" style="-fx-font-size: 18px; -fx-font-weight: bold;"/>

    <!-- 状态标签：显示加载状态或记录数量 -->
    <Label fx:id="statusLabel" text="正在加载数据..." style="-fx-font-size: 12px;"/>

    <!-- 使用 TabPane 切换会话列表和详细记录 -->
    <TabPane fx:id="mainTabPane" VBox.vgrow="ALWAYS">
        <!-- 监控会话列表标签页 -->
        <Tab text="监控会话列表" closable="false">
            <SplitPane dividerPositions="0.7" VBox.vgrow="ALWAYS">
                <!-- 左侧：会话列表表格 -->
                <TableView fx:id="sessionTable" VBox.vgrow="ALWAYS">
                    <columns>
                        <TableColumn fx:id="sessionIdColumn" text="会话ID" prefWidth="80.0" />
                        <TableColumn fx:id="sessionIfaceColumn" text="网卡名称" prefWidth="150.0" />
                        <TableColumn fx:id="sessionStartTimeColumn" text="开始时间" prefWidth="180.0" />
                        <TableColumn fx:id="sessionEndTimeColumn" text="结束时间" prefWidth="180.0" />
                        <TableColumn fx:id="sessionDurationColumn" text="持续时间(秒)" prefWidth="120.0" />
                        <TableColumn fx:id="sessionAvgDownColumn" text="平均下行(KB/s)" prefWidth="130.0" />
                        <TableColumn fx:id="sessionAvgUpColumn" text="平均上行(KB/s)" prefWidth="130.0" />
                        <TableColumn fx:id="sessionMaxDownColumn" text="最大下行(KB/s)" prefWidth="130.0" />
                        <TableColumn fx:id="sessionMaxUpColumn" text="最大上行(KB/s)" prefWidth="130.0" />
                        <TableColumn fx:id="sessionRecordCountColumn" text="记录数" prefWidth="80.0" />
                    </columns>
                </TableView>
                
                <!-- 右侧：会话详情 -->
                <VBox spacing="15.0" styleClass="detail-container" VBox.vgrow="ALWAYS">
                    <Label text="会话详情" styleClass="detail-title"/>
                    
                    <!-- 数据卡片区域 -->
                    <VBox fx:id="sessionDetailContainer" spacing="10.0" VBox.vgrow="NEVER">
                        <!-- 基本信息卡片网格 -->
                        <GridPane fx:id="sessionInfoGrid" styleClass="data-card-grid" hgap="10.0" vgap="10.0">
                            <columnConstraints>
                                <ColumnConstraints hgrow="SOMETIMES" minWidth="100.0" prefWidth="150.0"/>
                                <ColumnConstraints hgrow="SOMETIMES" minWidth="100.0" prefWidth="150.0"/>
                            </columnConstraints>
                            
                            <!-- 会话ID卡片 -->
                            <VBox styleClass="data-card" GridPane.columnIndex="0" GridPane.rowIndex="0">
                                <Label text="会话ID" styleClass="data-card-title"/>
                                <HBox spacing="4.0" alignment="BASELINE_LEFT">
                                    <Label fx:id="sessionIdLabel" text="--" styleClass="data-card-value"/>
                                </HBox>
                            </VBox>
                            
                            <!-- 网卡名称卡片 -->
                            <VBox styleClass="data-card" GridPane.columnIndex="1" GridPane.rowIndex="0">
                                <Label text="网卡名称" styleClass="data-card-title"/>
                                <Label fx:id="sessionIfaceLabel" text="--" styleClass="data-card-value" wrapText="true"/>
                            </VBox>
                            
                            <!-- 开始时间卡片 -->
                            <VBox styleClass="data-card" GridPane.columnIndex="0" GridPane.rowIndex="1">
                                <Label text="开始时间" styleClass="data-card-title"/>
                                <Label fx:id="sessionStartTimeLabel" text="--" styleClass="data-card-value" wrapText="true"/>
                            </VBox>
                            
                            <!-- 结束时间卡片 -->
                            <VBox styleClass="data-card" GridPane.columnIndex="1" GridPane.rowIndex="1">
                                <Label text="结束时间" styleClass="data-card-title"/>
                                <Label fx:id="sessionEndTimeLabel" text="--" styleClass="data-card-value" wrapText="true"/>
                            </VBox>
                            
                            <!-- 持续时间卡片 -->
                            <VBox styleClass="data-card" GridPane.columnIndex="0" GridPane.rowIndex="2">
                                <Label text="持续时间" styleClass="data-card-title"/>
                                <HBox spacing="4.0" alignment="BASELINE_LEFT">
                                    <Label fx:id="sessionDurationLabel" text="--" styleClass="data-card-value"/>
                                    <Label text="秒" styleClass="data-card-unit"/>
                                </HBox>
                            </VBox>
                            
                            <!-- 记录数卡片 -->
                            <VBox styleClass="data-card" GridPane.columnIndex="1" GridPane.rowIndex="2">
                                <Label text="记录数" styleClass="data-card-title"/>
                                <HBox spacing="4.0" alignment="BASELINE_LEFT">
                                    <Label fx:id="sessionRecordCountLabel" text="--" styleClass="data-card-value"/>
                                    <Label text="条" styleClass="data-card-unit"/>
                                </HBox>
                            </VBox>
                        </GridPane>
                        
                        <!-- 流量速度指标卡片网格 -->
                        <GridPane fx:id="sessionSpeedGrid" styleClass="data-card-grid" hgap="10.0" vgap="10.0">
                            <columnConstraints>
                                <ColumnConstraints hgrow="SOMETIMES" minWidth="100.0" prefWidth="150.0"/>
                                <ColumnConstraints hgrow="SOMETIMES" minWidth="100.0" prefWidth="150.0"/>
                            </columnConstraints>
                            
                            <!-- 平均下行速度卡片 -->
                            <VBox styleClass="data-card" GridPane.columnIndex="0" GridPane.rowIndex="0">
                                <Label text="平均下行速度" styleClass="data-card-title"/>
                                <HBox spacing="4.0" alignment="BASELINE_LEFT">
                                    <Label fx:id="sessionAvgDownLabel" text="--" styleClass="data-card-value"/>
                                    <Label text="KB/s" styleClass="data-card-unit"/>
                                </HBox>
                            </VBox>
                            
                            <!-- 平均上行速度卡片 -->
                            <VBox styleClass="data-card" GridPane.columnIndex="1" GridPane.rowIndex="0">
                                <Label text="平均上行速度" styleClass="data-card-title"/>
                                <HBox spacing="4.0" alignment="BASELINE_LEFT">
                                    <Label fx:id="sessionAvgUpLabel" text="--" styleClass="data-card-value"/>
                                    <Label text="KB/s" styleClass="data-card-unit"/>
                                </HBox>
                            </VBox>
                            
                            <!-- 最大下行速度卡片 -->
                            <VBox styleClass="data-card" GridPane.columnIndex="0" GridPane.rowIndex="1">
                                <Label text="最大下行速度" styleClass="data-card-title"/>
                                <HBox spacing="4.0" alignment="BASELINE_LEFT">
                                    <Label fx:id="sessionMaxDownLabel" text="--" styleClass="data-card-value"/>
                                    <Label text="KB/s" styleClass="data-card-unit"/>
                                </HBox>
                            </VBox>
                            
                            <!-- 最大上行速度卡片 -->
                            <VBox styleClass="data-card" GridPane.columnIndex="1" GridPane.rowIndex="1">
                                <Label text="最大上行速度" styleClass="data-card-title"/>
                                <HBox spacing="4.0" alignment="BASELINE_LEFT">
                                    <Label fx:id="sessionMaxUpLabel" text="--" styleClass="data-card-value"/>
                                    <Label text="KB/s" styleClass="data-card-unit"/>
                                </HBox>
                            </VBox>
                        </GridPane>
                        
                        <!-- 空状态提示 -->
                        <Label fx:id="sessionDetailPlaceholder" text="选择会话查看详细信息..." 
                               style="-fx-text-fill: #999999; -fx-font-size: 13px; -fx-alignment: center;"
                               visible="true" managed="true">
                            <VBox.margin>
                                <Insets top="20.0" bottom="20.0"/>
                            </VBox.margin>
                        </Label>
                    </VBox>
                    
                    <!-- 操作按钮组 -->
                    <HBox spacing="10.0" alignment="CENTER">
                        <Button fx:id="aiDiagnosisButton" text="AI 诊断" 
                                onAction="#onAIDiagnosisClick"
                                prefWidth="120.0"/>
                        <Button fx:id="exportExcelButton" text="导出 Excel" 
                                onAction="#onExportExcelClick"
                                prefWidth="120.0"/>
                        <Button fx:id="exportPDFButton" text="导出 PDF" 
                                onAction="#onExportPDFClick"
                                prefWidth="120.0"/>
                        <Button fx:id="deleteSessionButton" text="删除会话" 
                                onAction="#onDeleteSessionClick"
                                prefWidth="120.0"/>
                    </HBox>
                    
                    <!-- AI 诊断结果展示区域 -->
                    <VBox spacing="5.0" VBox.vgrow="ALWAYS" visible="false" managed="false" fx:id="aiDiagnosisContainer">
                        <VBox.margin>
                            <Insets top="10.0"/>
                        </VBox.margin>
                        <HBox spacing="10.0" alignment="CENTER_LEFT">
                            <Label text="AI 诊断结果" style="-fx-font-size: 14px; -fx-font-weight: bold;"/>
                            <Button fx:id="openReportWindowButton" text="在独立窗口中查看" 
                                    onAction="#onOpenReportWindowClick"
                                    style="-fx-pref-width: 150px; -fx-background-color: #2196F3; -fx-text-fill: white;"
                                    visible="false" managed="false">
                                <HBox.margin>
                                    <Insets left="10.0"/>
                                </HBox.margin>
                            </Button>
                            <Button fx:id="viewSystemPromptButton" text="查看系统 Prompt" 
                                    onAction="#onViewSystemPromptClick"
                                    style="-fx-pref-width: 160px; -fx-background-color: #9C27B0; -fx-text-fill: white;"
                                    visible="false" managed="false">
                                <HBox.margin>
                                    <Insets left="10.0"/>
                                </HBox.margin>
                            </Button>
                            <Button fx:id="cancelAIDiagnosisButton" text="取消诊断" 
                                    onAction="#onCancelAIDiagnosisClick"
                                    style="-fx-pref-width: 100px; -fx-background-color: #ff9800; -fx-text-fill: white;"
                                    visible="false" managed="false">
                                <HBox.margin>
                                    <Insets left="10.0"/>
                                </HBox.margin>
                            </Button>
                        </HBox>
                        <!-- 使用 WebView 替代 TextArea，支持 Markdown 渲染 -->
                        <WebView fx:id="aiDiagnosisWebView" VBox.vgrow="ALWAYS">
                            <VBox.margin>
                                <Insets top="5.0"/>
                            </VBox.margin>
                        </WebView>
                        <ProgressIndicator fx:id="aiDiagnosisProgress" visible="false" 
                                           style="-fx-pref-width: 30px; -fx-pref-height: 30px;">
                            <VBox.margin>
                                <Insets top="5.0"/>
                            </VBox.margin>
                        </ProgressIndicator>
                    </VBox>
                </VBox>
            </SplitPane>
        </Tab>
        
        <!-- 详细记录标签页 -->
        <Tab text="详细记录" closable="false">
            <!-- 使用 SplitPane 分割主表格和侧边栏 -->
            <SplitPane dividerPositions="0.7" VBox.vgrow="ALWAYS">
                <!-- 左侧：历史数据表格 -->
                <TableView fx:id="historyTable" VBox.vgrow="ALWAYS">
            <!-- 设置表格列 -->
            <columns>
                <!-- ID 列 -->
                <TableColumn fx:id="idColumn" text="ID" prefWidth="60.0" />
                
                <!-- 下行速度列 -->
                <TableColumn fx:id="downSpeedColumn" text="下行速度 (KB/s)" prefWidth="130.0" />
                
            <!-- 上行速度列 -->
            <TableColumn fx:id="upSpeedColumn" text="上行速度 (KB/s)" prefWidth="130.0" />
            
            <!-- 源IP地址列 -->
            <TableColumn fx:id="sourceIpColumn" text="源IP" prefWidth="150.0" />
            
            <!-- 目标IP地址列 -->
            <TableColumn fx:id="destIpColumn" text="目标IP" prefWidth="150.0" />
            
            <!-- 进程名称列 -->
            <TableColumn fx:id="processNameColumn" text="进程名称" prefWidth="200.0" />
            
            <!-- 协议列 -->
            <TableColumn fx:id="protocolColumn" text="协议" prefWidth="80.0" />
            
            <!-- 捕获时间列 -->
            <TableColumn fx:id="captureTimeColumn" text="捕获时间" prefWidth="200.0" />
            </columns>
        </TableView>
        
        <!-- 右侧：记录详情和过滤条件 -->
        <SplitPane orientation="VERTICAL" dividerPositions="0.5" VBox.vgrow="ALWAYS">
            <!-- 上半部分：记录详情 -->
            <VBox spacing="15.0" styleClass="detail-container" VBox.vgrow="ALWAYS">
                <Label text="记录详情" styleClass="detail-title"/>
                
                <!-- 数据卡片区域 -->
                <VBox fx:id="recordDetailContainer" spacing="10.0" VBox.vgrow="NEVER">
                    <!-- 基本信息卡片网格 -->
                    <GridPane fx:id="recordInfoGrid" styleClass="data-card-grid" hgap="10.0" vgap="10.0">
                        <columnConstraints>
                            <ColumnConstraints hgrow="SOMETIMES" minWidth="100.0" prefWidth="150.0"/>
                            <ColumnConstraints hgrow="SOMETIMES" minWidth="100.0" prefWidth="150.0"/>
                        </columnConstraints>
                        
                        <!-- 记录ID卡片 -->
                        <VBox styleClass="data-card" GridPane.columnIndex="0" GridPane.rowIndex="0">
                            <Label text="记录ID" styleClass="data-card-title"/>
                            <HBox spacing="4.0" alignment="BASELINE_LEFT">
                                <Label fx:id="recordIdLabel" text="--" styleClass="data-card-value"/>
                            </HBox>
                        </VBox>
                        
                        <!-- 捕获时间卡片 -->
                        <VBox styleClass="data-card" GridPane.columnIndex="1" GridPane.rowIndex="0">
                            <Label text="捕获时间" styleClass="data-card-title"/>
                            <Label fx:id="recordCaptureTimeLabel" text="--" styleClass="data-card-value" wrapText="true"/>
                        </VBox>
                        
                        <!-- 协议类型卡片 -->
                        <VBox styleClass="data-card" GridPane.columnIndex="0" GridPane.rowIndex="1">
                            <Label text="协议类型" styleClass="data-card-title"/>
                            <Label fx:id="recordProtocolLabel" text="--" styleClass="data-card-value"/>
                        </VBox>
                        
                        <!-- 进程名称卡片 -->
                        <VBox styleClass="data-card" GridPane.columnIndex="1" GridPane.rowIndex="1">
                            <Label text="进程名称" styleClass="data-card-title"/>
                            <Label fx:id="recordProcessNameLabel" text="--" styleClass="data-card-value" wrapText="true"/>
                        </VBox>
                        
                        <!-- 源IP地址卡片 -->
                        <VBox styleClass="data-card" GridPane.columnIndex="0" GridPane.rowIndex="2">
                            <Label text="源IP地址" styleClass="data-card-title"/>
                            <Label fx:id="recordSourceIpLabel" text="--" styleClass="data-card-value" wrapText="true"/>
                        </VBox>
                        
                        <!-- 目标IP地址卡片 -->
                        <VBox styleClass="data-card" GridPane.columnIndex="1" GridPane.rowIndex="2">
                            <Label text="目标IP地址" styleClass="data-card-title"/>
                            <Label fx:id="recordDestIpLabel" text="--" styleClass="data-card-value" wrapText="true"/>
                        </VBox>
                    </GridPane>
                    
                    <!-- 流量速度指标卡片网格 -->
                    <GridPane fx:id="recordSpeedGrid" styleClass="data-card-grid" hgap="10.0" vgap="10.0">
                        <columnConstraints>
                            <ColumnConstraints hgrow="SOMETIMES" minWidth="100.0" prefWidth="150.0"/>
                            <ColumnConstraints hgrow="SOMETIMES" minWidth="100.0" prefWidth="150.0"/>
                        </columnConstraints>
                        
                        <!-- 下行速度卡片 -->
                        <VBox styleClass="data-card" GridPane.columnIndex="0" GridPane.rowIndex="0">
                            <Label text="下行速度" styleClass="data-card-title"/>
                            <HBox spacing="4.0" alignment="BASELINE_LEFT">
                                <Label fx:id="recordDownSpeedLabel" text="--" styleClass="data-card-value"/>
                                <Label text="KB/s" styleClass="data-card-unit"/>
                            </HBox>
                        </VBox>
                        
                        <!-- 上行速度卡片 -->
                        <VBox styleClass="data-card" GridPane.columnIndex="1" GridPane.rowIndex="0">
                            <Label text="上行速度" styleClass="data-card-title"/>
                            <HBox spacing="4.0" alignment="BASELINE_LEFT">
                                <Label fx:id="recordUpSpeedLabel" text="--" styleClass="data-card-value"/>
                                <Label text="KB/s" styleClass="data-card-unit"/>
                            </HBox>
                        </VBox>
                    </GridPane>
                    
                    <!-- 空状态提示 -->
                    <Label fx:id="recordDetailPlaceholder" text="选择记录查看详细信息..." 
                           style="-fx-text-fill: #999999; -fx-font-size: 13px; -fx-alignment: center;"
                           visible="true" managed="true">
                        <VBox.margin>
                            <Insets top="20.0" bottom="20.0"/>
                        </VBox.margin>
                    </Label>
                </VBox>
            </VBox>
            
            <!-- 下半部分：过滤条件和IP查询 -->
            <VBox spacing="15.0" style="-fx-padding: 15px;" VBox.vgrow="ALWAYS">
                <!-- 过滤设置面板 -->
                <TitledPane text="过滤设置" collapsible="true" expanded="true" styleClass="filter-titled-pane">
                    <VBox spacing="15.0" style="-fx-padding: 15px;">
                        <!-- 协议类型、应用（进程）和清除过滤按钮在同一行 -->
                        <HBox spacing="20.0" alignment="CENTER_LEFT">
                            <!-- 协议过滤（横向排列） -->
                            <VBox spacing="8.0" HBox.hgrow="NEVER">
                                <Label text="协议类型" style="-fx-font-size: 13px; -fx-font-weight: bold;"/>
                                <HBox spacing="10.0">
                                    <CheckBox fx:id="protocolTcpCheckBox" text="TCP"/>
                                    <CheckBox fx:id="protocolUdpCheckBox" text="UDP"/>
                                    <CheckBox fx:id="protocolOtherCheckBox" text="其他"/>
                                </HBox>
                            </VBox>
                            
                            <!-- 应用过滤 -->
                            <VBox spacing="8.0" HBox.hgrow="NEVER">
                                <Label text="应用（进程）" style="-fx-font-size: 13px; -fx-font-weight: bold;"/>
                                <ComboBox fx:id="processNameComboBox" promptText="选择应用..." 
                                         style="-fx-pref-width: 180px;"/>
                            </VBox>
                            
                            <!-- 清除过滤按钮（右对齐） -->
                            <Region HBox.hgrow="ALWAYS"/>
                            <VBox spacing="8.0" alignment="BOTTOM_RIGHT">
                                <Label text=" " style="-fx-font-size: 13px; -fx-font-weight: bold;"/>
                                <Button text="清除过滤" onAction="#onClearFiltersClick" 
                                       styleClass="clear-filter-button"/>
                            </VBox>
                        </HBox>
                        
                        <!-- 流量阈值过滤 -->
                        <VBox spacing="8.0">
                            <Label text="最小下载速度" style="-fx-font-size: 13px; -fx-font-weight: bold;"/>
                            <HBox spacing="5.0" alignment="CENTER_LEFT">
                                <TextField fx:id="minDownSpeedTextField" promptText="0.0" 
                                          style="-fx-pref-width: 100px;" HBox.hgrow="ALWAYS"/>
                                <Label text="KB/s" style="-fx-font-size: 12px;"/>
                            </HBox>
                            <Slider fx:id="minDownSpeedSlider" min="0" max="10000" value="0" 
                                   showTickLabels="true" showTickMarks="true" majorTickUnit="2000" 
                                   minorTickCount="4" blockIncrement="100"/>
                        </VBox>
                    </VBox>
                </TitledPane>
                
                <!-- IP 工具面板 -->
                <TitledPane text="IP 工具" collapsible="true" expanded="true" styleClass="ip-tool-titled-pane" VBox.vgrow="ALWAYS">
                    <ScrollPane fitToWidth="true" VBox.vgrow="ALWAYS">
                        <VBox spacing="12.0" style="-fx-padding: 15px;">
                            <!-- IP 输入区域 -->
                            <VBox spacing="5.0">
                                <Label text="输入 IP 地址：" style="-fx-font-size: 12px; -fx-font-weight: 500;"/>
                                <HBox spacing="5.0">
                                    <TextField fx:id="ipInputField" promptText="例如: 8.8.8.8" 
                                               style="-fx-pref-width: 200px;"/>
                                    <Button fx:id="queryIpButton" text="查询" 
                                            onAction="#onQueryIpButtonClick"
                                            style="-fx-pref-width: 80px;"/>
                                </HBox>
                            </VBox>
                            
                            <!-- IP 归属地信息显示区域（结构化Label） -->
                            <VBox spacing="8.0" fx:id="ipLocationContainer" styleClass="ip-location-container">
                                <Label text="地理位置信息" style="-fx-font-size: 12px; -fx-font-weight: 500;"/>
                                <VBox spacing="6.0" fx:id="ipLocationInfoBox" styleClass="ip-location-info-box">
                                    <!-- 动态填充的Label将在这里显示 -->
                                </VBox>
                            </VBox>
                            
                            <!-- 提示信息 -->
                            <Label fx:id="ipQueryStatusLabel" text="点击表格行或输入 IP 地址进行查询" 
                                   style="-fx-font-size: 11px; -fx-text-fill: #757575;"/>
                        </VBox>
                    </ScrollPane>
                </TitledPane>
            </VBox>
            </SplitPane>
            </SplitPane>
        </Tab>
    </TabPane>

    <!-- 底部按钮区域 -->
    <HBox spacing="10.0" alignment="CENTER_RIGHT">
        <!-- 刷新按钮 -->
        <Button fx:id="refreshButton" text="刷新" onAction="#onRefreshButtonClick" 
                style="-fx-pref-width: 100px;"/>
        
        <!-- 关闭按钮 -->
        <Button fx:id="closeButton" text="关闭" onAction="#onCloseButtonClick"
                style="-fx-pref-width: 100px;"/>
    </HBox>
</VBox>



